# Delta Juvenile Fish Monitoring Program
# Trawl data 2012 - 2021
# Drought analysis

####################
### Read in data ###
####################
# folder
setwd("C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/new trawls")
# create list of files in folder
file_list <- list.files()
# read in all files in the folder and combine
for (file in file_list){
  
  # if the merged dataset doesn't exist, create it
  if (file==file_list[1]){
    dataset <- read.csv(file, header=TRUE, stringsAsFactors = F)
    dataset$filename <- file # add filename as a column
  }
  
  # if the merged dataset does exist, append to it
  if (file!=file_list[1]){
    temp_dataset <-read.csv(file, header=TRUE, stringsAsFactors = F)
    temp_dataset$filename <- file
    dataset<-rbind(dataset, temp_dataset)
    rm(temp_dataset)
  }
}

new_trawl <- dataset
remove(file)
remove(file_list)
remove(dataset)

# change date and time to date and time formats
  library(lubridate)
  new_trawl$Date <- mdy(new_trawl$Date)
  #new_trawl$Time <- hms(new_trawl$Time)
  new_trawl$mday <- mday(new_trawl$Date)
# add Water Year as column
  # January 1 to September 30 = same as calendar year
  # October 1 to December 31 = calendar year + 1
  library(dplyr) 
  # binary for whether water year and calendar year are the same
  # as.numeric --> 0 for same, 1 for add 1 year
  new_trawl$same_year <- as.numeric(between(month(new_trawl$Date),10,12))
  # water year (WY) column
  new_trawl$WY <- year(new_trawl$Date) + new_trawl$same_year
  
# Variable to identify each trawl tow
new_trawl$Tow <- paste(new_trawl$Date, new_trawl$Station, new_trawl$TowNumber)
  
# subset for just Chinook CHN
Chinook_trawl <- new_trawl[new_trawl$Species=="CHN",]
# subset for rainbow trout/steelhead (RBT)  
steelhead_trawl <- new_trawl[new_trawl$Species=="RBT",]

########################
### CDEC Water Years ###
########################
library(tidyverse)
library(readxl)
WaterYr <- read_excel("C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/CDEC Water Year Hydrologic Classification Indices.xlsx", 
                      sheet = "Sheet3")
# or use waterYearType package?!
  #install.packages("waterYearType")
  #library(waterYearType)
  # look like this is the same data as Sheet 1
  # reconstructed - 1901 - 2017

#########################################
### Drought group-defined Water Years ###
#########################################
DroughtYr <- read.csv("C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/from Pete/yearassignments.csv")

##################################
##### sums by week
###################
# need to sum to get a distribution over the year
# looks like Peter did by week: cpue = chn_wk/sets_wk
# need to account for more trawls/sampling effort in some day vs others
# also have adults in the data

# want total Chinook in each Date*Station*TowNumber (aka trawl)
# this gets the basics, but not additional variables:
#Chinook_summary <- aggregate(Chinook_trawl$Catch, 
#                             by=list(Category=(Chinook_trawl$Tow)), 
#                             FUN=sum)
  #would be nice to keep a summary of other variables too though...



# KEEP: Location, Station, Date, Secchi, DO, WaterTemp, Turbidity,
  # Conductivity, WY
  # removed environ variables due to different values for same tow

# there are also fork lengths -- consider for later
# will want to look at race later too

# first, remove adults -- only want juveniles for outmigration timing
Chinook_trawl_juv <- Chinook_trawl[!Chinook_trawl$RaceByLength=="Adult",]


Chinook_sum <- Chinook_trawl_juv %>%
  group_by(Tow) %>%
  dplyr::summarize(
          Catch_sum = sum(Catch),
          Location = Location, 
          Station = Station, 
          Date = Date, 
          #Secchi= Secchi, 
          #DO = DO, 
          #WaterTemp = WaterTemp, 
          #Turbidity = Turbidity,
          #Conductivity = Conductivity, 
          WY = WY,
          Tow = Tow
          ) 

# sum dataset should have same number of rows as unique tows
#length(unique(Chinook_trawl_juv$Tow))
#length(unique(Chinook_sum$Tow))
# BUT how I coded this does not
# for now, just remove duplicate rows
Chinook_sum_unique <- Chinook_sum[!duplicated(Chinook_sum),]
# a difference of 3 still in expected length...
  # fixed by removing environ variables
  # Chinook_sum_unique$Tow[duplicated(Chinook_sum_unique$Tow)]
  #[1] "2017-04-09 SR055M 9" GearCOndition 9 = gilled in net, not caught 
  #[2] "2017-04-23 SB018N 2" two different turbidities??
  #[3] "2021-04-30 SB018M 8" all diff environ values??
  # for summing over weeks, won't keep environ data anyway...



# then total Chinook in each week, total trawls in each week
# calculate Chinook/trawl per week
# keep all the same variables...
  # add week column
library(tsibble)
library(tidyverse)
  Chinook_sum_unique$year_wk = yearweek(Chinook_sum_unique$Date)
  # counter for each row to sum number of tows per week
  Chinook_sum_unique$N <- 1
  
Chinook_wksum <- Chinook_sum_unique %>%
  group_by(year_wk) %>%
  dplyr::summarize(
          Catch_sum = sum(Catch_sum),
          NTows = sum(N),
          WY = WY,
          year_wk = year_wk
          ) 
# remove duplicates
Chinook_wksum2 <- Chinook_wksum[!duplicated(Chinook_wksum),]
#(2020-2011)*52 # rough calculation of number of weeks possible
#length(unique(Chinook_wksum2$year_wk)) 

# calculate cpue
Chinook_wksum2$cpue <- Chinook_wksum2$Catch_sum / Chinook_wksum2$NTows
# create week column
Chinook_wksum2$wk <- week(Chinook_wksum2$year_wk)

# this data includes some WY 2011, but very little
  # only plot 2012-2021
Chinook_wksum2 <- Chinook_wksum2[(Chinook_wksum2$WY > 2011 & 
                                    Chinook_wksum2$WY <2022),]
plot(Chinook_wksum2$cpue~Chinook_wksum2$wk)
# would be great to start around week 38 or something
  # and go through end of that year, beginning of next
  # to correspond to water year
## ask peter how he did Water-Year Week (Oct - Sep) ***

# bring in water year info
Chinook <- left_join(Chinook_wksum2, WaterYr, by="WY")

library(ggplot2)
ggplot(Chinook) + 
  geom_point(aes(wk, cpue, color= Sac_Index))

# would be better to fit lines to each year
# what do we want to do about the outliers?
  # highest 3 cpue are all in 2014
# separate out/account for site?

###################################
### Starting over a little bit
# want each run and location separate
###################
# let's get water day (day of year but for water year)
# use difftime to get wtr_day to be the number of days from 9-30 
# in the previous water year (WY)
# for Chinook dataset first (could have done for all trawl data initially...)
Chinook_trawl <- Chinook_trawl %>%
  group_by(WY) %>% 
  mutate(wtr_day = (as.integer(difftime(
    Date,ymd(paste0(WY - 1 ,'-09-30')), units = "days"))))

# combine Water Year and water index data
Chinook_WY <- left_join(Chinook_trawl, WaterYr)
# remove adults
Chinook_WY <- Chinook_WY[!Chinook_WY$RaceByLength=="Adult",]

################
# violin plots #
################

# change column name for sac year type
colnames(Chinook_WY)[31] <- "Sac_Yrtype"
# remove 2011 and 2022 - incomplete years
Chinook_WY <- Chinook_WY[(Chinook_WY$WY > 2011),]
Chinook_WY <- Chinook_WY[(Chinook_WY$WY < 2022),]

# expand rows to account for Catch
Chinook_WY.expanded <- Chinook_WY[rep(row.names(Chinook_WY), Chinook_WY$Catch), ]

# start with fall-run, Chipp's Island # colro by water year type
a <- ggplot(Chinook_WY.expanded[Chinook_WY.expanded$Location=="Chipps Island" & 
                         Chinook_WY.expanded$RaceByLength=="Fall",], 
             aes(x=as.factor(WY), y=wtr_day, fill=as.factor(Sac_Yrtype))) + 
  geom_violin() +ggtitle("Chipp's Island Fall-run") #+ geom_boxplot(width=0.1)
a

# start with fall-run, Chipp's Island # color by Sac Index
b <- ggplot(Chinook_WY.expanded[Chinook_WY.expanded$Location=="Chipps Island" & 
                         Chinook_WY.expanded$RaceByLength=="Fall",], 
             aes(x=as.factor(WY), y=wtr_day, fill=Sac_Index)) + 
  geom_violin() +ggtitle("Chipp's Island Fall-run")#+ geom_boxplot(width=0.1)
b


#test <- Chinook_WY.expanded[Chinook_WY.expanded$Location=="Sherwood Harbor",]
#test2 <- test[test$RaceByLength=="Fall",]
#test3 <- Chinook_WY.expanded[Chinook_WY.expanded$Location=="Sherwood Harbor" &
#                         Chinook_WY.expanded$RaceByLength=="Fall",]

# try a different one...
c <- ggplot(Chinook_WY.expanded[Chinook_WY.expanded$Location=="Sherwood Harbor" &
                         Chinook_WY.expanded$RaceByLength=="Fall" ,], 
             aes(x=as.factor(WY), y=wtr_day, fill=Sac_Index)) + 
  geom_violin() +ggtitle("Sherwood Harbor Fall-run")#+ geom_boxplot(width=0.1)
c

#########################
# loop for violin plots #
#########################
locations <- unique(Chinook_WY.expanded$Location)
runs <- unique(Chinook_WY.expanded$RaceByLength)
  # only want runs 1, 3, 4, 5
  # need separate for steelhead

for (i in 1:length(locations)){ # i is location
  for (j in c(1,3,4,5)){ # j is run
    # need to wrap ggplot in print function for it to
    # plot within the loop
    print(ggplot(Chinook_WY.expanded[Chinook_WY.expanded$Location==
                                 paste(locations[i]) &
                         Chinook_WY.expanded$RaceByLength==
                           paste(runs[j]) ,], 
             aes(x=as.factor(WY), y=wtr_day, fill=Sac_Index)) + 
    geom_violin() +
      labs(title = paste(noquote(locations[i])," ",noquote(runs[j]),"-run Chinook ","Migration Timing",sep=""), x = "Sac Index", 
           y = "Day of water year", color = "Sac Index"))
    dev.copy(svg,(paste("C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/",noquote(locations[i])," ",noquote(runs[j]),"-run Chinook ","Migration Timing.svg",sep="")))
    dev.off()
 
  }
  
}
# a bunch of errors, but they seem reasonable?
# plots plotted...
# groups with fewer than 2 data points have been dropped
# are there groups with fewer than 2 data points???

##############
#### ANOVA ###
##############

anova1 <- aov(Chinook_WY.expanded$wtr_day ~ Chinook_WY.expanded$Location
            + Chinook_WY.expanded$RaceByLength + Chinook_WY.expanded$Sac_Yrtype)
summary(anova1)
# 3450 observations deleted due to missingness
# missing races?
posthoc <- TukeyHSD(x=anova1, 'Chinook_WY.expanded$Sac_Yrtype', conf.level=0.95)
posthoc

plot(anova1)
# there does seem to be a pattern in the residuals
# some strong leverage points?

anova0.5 <- aov(Chinook_WY.expanded$wtr_day ~ Chinook_WY.expanded$Location
            + Chinook_WY.expanded$RaceByLength + Chinook_WY.expanded$WY)
summary(anova0.5)


# let's look at just fall-run for Sherwood Harbor
Chinook_WY.expanded2 <- Chinook_WY.expanded[Chinook_WY.expanded$Location=="Sherwood Harbor" &
                         Chinook_WY.expanded$RaceByLength=="Fall" ,]
anova2 <- aov(Chinook_WY.expanded2$wtr_day ~ Chinook_WY.expanded2$Sac_Yrtype)
summary(anova2)

# 1/4/2022 trying another
model <- aov(wtr_day~as.factor(WY), data=Chinook_WY.expanded2)
summary(model)

model2 <- Anova(model, type=2)
model2 # same sum of squares as above?!

TukeyHSD(model, conf.level=.95) 
# not different:
  # 2018-2012
  # 2020-2014
  # 2019-2016
  # 2021-2016

# by water year type
model <- aov(wtr_day~Sac_Yrtype + as.factor(WY), data=Chinook_WY.expanded2)
summary(model)
TukeyHSD(model, conf.level=.95) 
# all water year types different
# different year pairwise differences than before...

###################################
#         some other plots        #
#           SacPAS data           #
# just Sherwood fall-run to start #
###################################

# read in SacPAS data
# Sherwood fall-run for now
Sherwood_fall <- read.csv("C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/SacPAS/trawl summaries/Sherwood Harbor Fall-run hrt_1640019304_674.csv")
## need to delete top 3 rows
Sherwood_fall = Sherwood_fall[-(1:3),]
# add water year stats
# check brood year to water year math for each run
Sherwood_fall$WY <- as.numeric(Sherwood_fall$Brood.Year)+1
Sherwood_fall <- left_join(Sherwood_fall, WaterYr)
# switch dates to water day
#colnames(Sherwood_fall)[2:10]
for (i in 2:10){
  # switch dates to date format
  Sherwood_fall[,i] <- mdy(Sherwood_fall[,i])
}

# creating a list of new column names
newcol <- rep(NA,9)
for (i in 2:10){
  newcol[i-1] <- paste(colnames(Sherwood_fall)[i],"_wtrday",sep="")
}
# add new columns with those names
for(i in newcol){
    Sherwood_fall[,i] <- NA}

# create water day columns of dates
for (i in 2:10){
  Sherwood_fall[,(i+19)] = (as.integer(difftime(
    Sherwood_fall[,i],ymd(paste0(Sherwood_fall$WY - 1 ,'-09-30')), units = "days")))
}

## fix some variable types
# should be number
Sherwood_fall$Run.Size <- as.numeric(Sherwood_fall$Run.Size)
# should be factors
Sherwood_fall$`Sac_Yr-type` <- factor(Sherwood_fall$`Sac_Yr-type`, 
                                      levels=c("C","D","BN","AN","W"), 
                                      ordered=TRUE)
Sherwood_fall$`SJ_Yr-type` <- factor(Sherwood_fall$`SJ_Yr-type`, 
                                      levels=c("C","D","BN","AN","W"), 
                                      ordered=TRUE)

# plot timing stats from SacPAS against water year type/index
  pairs(Sherwood_fall[,c(11:14,16:29)])
# plot variables against Sac Index
  # no index for 2021 yet
library(reshape2)
# 11:13 are duration
  df <- melt(Sherwood_fall[,c(11:13,17)],
             id.vars = 'Sac_Index',
             variable.name = 'duration')
  # plot on same grid, each series colored differently
  ggplot(df, aes(Sac_Index,value)) + 
    geom_point(aes(colour = duration)) +
    labs(title = "Sherwood Harbor Trawl Fall-run Chinook Migration Duration", x = "Sac Index", 
         y = "Duration (days)", color = "Portion of run duration")+
    scale_color_hue(labels = c("Middle 80 days", 
                               "Middle 50 days",
                               "Middle 90 days"))

# 14 is run size
  # plot on same grid, each series colored differently
  ggplot(Sherwood_fall, aes(x=Sac_Index,y=Run.Size)) + 
    geom_point()  +
    labs(title="Sherwood Harbor Trawl Fall-run Chinook Run Size", x = "Sac Index", y="run size")
  # what's up with the massive run size in 2014?

# 21:29 are passage dates
    df <- melt(Sherwood_fall[,c(21:29,17)],
             id.vars = 'Sac_Index',
             variable.name = 'passage_dates')
  # plot on same grid, each series colored differently
  ggplot(df, aes(Sac_Index,value)) + 
    geom_point(aes(colour = passage_dates)) +
    labs(title = "Sherwood Harbor Trawl Fall-run Chinook Migration Timing", x = "Sac Index", 
         y = "Day of water year", color = "Portion of passage")+
    scale_color_hue(labels = c("First", "5%", "10%", "25",
                               "50%","75%","90%","95%","Last"))

# let's look at run duration
plot50 <- ggplot(Sherwood_fall, aes(Sac_Index,DurationMiddle50.Days)) + 
      geom_point()
plot80 <- ggplot(Sherwood_fall, aes(Sac_Index,DurationMiddle80.Days)) + 
      geom_point()
plot90 <- ggplot(Sherwood_fall, aes(Sac_Index,DurationMiddle90.Days)) + 
      geom_point()
library(gridExtra)
grid.arrange(plot50, plot80, plot90, nrow = 1)


##################################
#    let's try to make a loop    #
# to do plots for all sites/runs #
##################################
setwd("C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/SacPAS/trawl summaries/")
# create list of files in folder
file_list <- list.files()
# create list of names from the file names
  # we want everything before " hrt_"
  # this would be 23 characters off the end
names <-substr(file_list,1,nchar(file_list)-23)

# want to do all the steps to fix data and make plots
# 33 warnings -- all about rows containing missing values

# look at column names for all files
# 15 columns for 11 files
columns <- data.frame(matrix(ncol = 11, nrow = 15))
colnames(columns) <- names
for (i in 1:length(file_list)){
  testdf <- read.csv(paste("C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/SacPAS/trawl summaries/",noquote(file_list[i]),sep=""))
  columns[,i] <- colnames(testdf)
}
# Mossdale steelhead as Start.Year rather than Brood.Year
  # **manually fix this column name

for (i in 1:(length(file_list))){ # loop doesn't work; run by hand for each i
  # why is it length of list -1 ??? --> changed
  # read in SacPAS data
  df <- read.csv(paste("C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/SacPAS/trawl summaries/",noquote(file_list[i]),sep=""))
  ## need to delete top 3 rows
  df = df[-(1:3),]
  # add water year stats
  df$WY <- as.numeric(df$Brood.Year)+1
  df <- left_join(df, WaterYr)

  # switch dates to water day
  #colnames(df)[2:10]
  for (j in 2:10){
    # switch dates to date format
    df[,j] <- mdy(df[,j])
  }

  # creating a list of new column names
  newcol <- rep(NA,9)
  for (k in 2:10){
    newcol[k-1] <- paste(colnames(df)[k],"_wtrday",sep="")
  }
  # add new columns with those names
  for(l in newcol){
      df[,l] <- NA}

  # create water day columns of dates
  for (m in 2:10){
    df[,(m+19)] = (as.integer(difftime(
      df[,m],ymd(paste0(df$WY - 1 ,'-09-30')), units = "days")))
  }

  ## fix some variable types
  # should be number
  df$Run.Size <- as.numeric(df$Run.Size)
  # should be factors
  df$`Sac_Yr-type` <- factor(df$`Sac_Yr-type`, 
                                      levels=c("C","D","BN","AN","W"), 
                                      ordered=TRUE)
  df$`SJ_Yr-type` <- factor(df$`SJ_Yr-type`, 
                                      levels=c("C","D","BN","AN","W"), 
                                      ordered=TRUE)

  # plot variables against Sac Index
  # no index for 2021 yet
  library(reshape2)
  # 11:13 are duration
    df2 <- melt(df[,c(11:13,17)],
               id.vars = 'Sac_Index',
               variable.name = 'duration')
    # plot on same grid, each series colored differently
    print(ggplot(df2, aes(Sac_Index,value)) + 
      geom_point(aes(colour = duration)) +
      labs(title = paste(noquote(names[i]),"Migration Duration"), x = "Sac Index", 
           y = "Duration (days)", color = "Portion of run duration")+
      scale_color_hue(labels = c("Middle 80 days", 
                                 "Middle 50 days",
                                 "Middle 90 days")))
    dev.copy(svg,(paste("C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/SacPAS/plots/",noquote(names[i])," Migration Duration",".svg",sep="")))
    dev.off()
  # 14 is run size
    # plot on same grid, each series colored differently
    print(ggplot(df, aes(x=Sac_Index,y=Run.Size)) + 
      geom_point()  +
      labs(title=paste(noquote(names[i]),"Run Size"), x = "Sac Index", y="run size"))
    dev.copy(svg,(paste("C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/SacPAS/plots/",noquote(names[i])," Run Size",".svg",sep="")))
    dev.off()
    
  # 21:29 are passage dates
      df2 <- melt(df[,c(21:29,17)],
               id.vars = 'Sac_Index',
               variable.name = 'passage_dates')
    # plot on same grid, each series colored differently
    print(ggplot(df2, aes(Sac_Index,value)) + 
      geom_point(aes(colour = passage_dates)) +
      labs(title = paste(noquote(names[i]),"Migration Timing"), x = "Sac Index", 
           y = "Day of water year", color = "Portion of passage")+
      scale_color_hue(labels = c("First", "5%", "10%", "25",
                                 "50%","75%","90%","95%","Last")))
    dev.copy(svg,(paste("C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/SacPAS/plots/",noquote(names[i])," Migration Timing",".svg",sep="")))
    dev.off()

}


##############################################


###################
### Regressions ###
###################

################################
#  Sam Bashevkin's functions   #
# will need editing for my use #
#          for ANOAVs          #
################################
require(dplyr)
require(DroughtData) # no such package??
require(ggplot2)
require(patchwork)
require(knitr)
require(car)
require(multcomp)
require(emmeans)
require(stringr)
require(readr)
#save_dir<-file.path("FLOATDrought", "Outputs")

# Functions

model_plotter<-function(model, data){
  data<-data%>%
    mutate(Residuals=resid(model),
           Fitted=predict(model))
  
  p_hist<-ggplot(data, aes(x=Residuals))+
    geom_histogram()+
    xlab("Residuals (?C)")+
    theme_bw()
  
  p_res_fit<-ggplot(data, aes(x=Residuals, y=Fitted))+
    geom_point()+
    ylab("Predicted temperature (?C)")+
    xlab("Residuals (?C)")+
    theme_bw()
  
  p_obs_fit<-ggplot(data, aes(x=Temperature, y=Fitted))+
    geom_point()+
    geom_abline(slope=1, intercept=0, color="red")+
    ylab("Predicted temperature (?C)")+
    xlab("Observed temperature (?C)")+
    theme_bw()
  
  out<-(p_hist+plot_layout(ncol=1))+(p_res_fit+p_obs_fit+plot_layout(ncol=2))+plot_layout(nrow=2, widths=c(1, 0.5, 0.5))
  
  return(out)
}
tukey_plotter<-function(model, data, data_type, model_type){
  
  tuk<-emmeans(model, list(data=data_type, model=model_type))
  
  tuk_data<-as_tibble(cld(tuk$data, sort=FALSE, Letters = letters))%>%
    mutate(.group=str_remove_all(.group, fixed(" ")))%>%
    left_join(data%>%
                group_by(across(all_of(data_type)))%>%
                summarise(max_temp=max(Temperature), .groups="drop"),
              by=data_type)
  
  tuk_model<-as_tibble(cld(tuk$model, sort=FALSE, Letters = letters))%>%
    mutate(.group=str_remove_all(.group, fixed(" ")))%>%
    left_join(data%>%
                group_by(across(all_of(model_type)))%>%
                summarise(max_temp=max(Temperature), .groups="drop"),
              by=model_type)
  
  p_data<-ggplot(tuk_data, aes(x=.data[[data_type]], y=emmean, ymin=lower.CL, ymax=upper.CL, label=.group))+
    geom_boxplot(data=data, aes(x=.data[[data_type]], y=Temperature), inherit.aes = FALSE)+
    geom_pointrange(color="red", position=position_nudge(x=0.1))+
    geom_text(aes(y=max_temp+(max(data$Temperature)-min(data$Temperature))/20), size=6)+
    ylab("Temperature (?C)")+
    theme_bw(base_size=16)
  
  p_model<-ggplot(tuk_model, aes(x=.data[[model_type]], y=emmean, ymin=lower.CL, ymax=upper.CL, label=.group))+
    geom_boxplot(data=data, aes(x=.data[[model_type]], y=Temperature), inherit.aes = FALSE)+
    geom_pointrange(color="red", position=position_nudge(x=0.1))+
    geom_text(aes(y=max_temp+(max(data$Temperature)-min(data$Temperature))/20), angle=if_else(model_type=="Year_fac", 90, 0), hjust=if_else(model_type=="Year_fac", "left", NA_character_), vjust=0.25, size=6)+
    ylab("Temperature (?C)")+
    theme_bw(base_size=16)+
    {if(model_type=="Year_fac"){
      list(geom_tile(data=data, 
                     aes(x=Year_fac, y=min(Temperature)-(max(Temperature)-min(Temperature))/20, 
                         fill=Drought, height=(max(Temperature)-min(Temperature))/20), 
                     inherit.aes = FALSE),
           xlab("Year"),
           theme(axis.text.x=element_text(angle=90, vjust=0.5)),
           scale_y_continuous(expand = expansion(mult=c(0,0.1))),
           scale_fill_viridis_d(direction = -1))
    }}
  
  out<-p_data/p_model+plot_annotation(tag_levels="A")
  
  if(model_type=="Year_fac"){
    out<-out+plot_layout(heights = c(0.8, 1))
  }
  
  return(out)
}

#########
# ANOVA #
# * incomplete; need to edit Sam's code to work for me
#########
fall.aov <- aov(wtr_day ~ Sac_Yrtype + Location, 
                data=Chinook_WY.expanded[
                  Chinook_WY.expanded$RaceByLength=="Fall",])

summary(fall.aov)


#Check assumptions:
model_plotter(fall.aov, Chinook_WY.expanded[
                  Chinook_WY.expanded$RaceByLength=="Fall",])

#Check results
fall.aov_Anova<-Anova(fall.aov, type=2)
fall.aov_Anova

#post-hoc test
p_fall.aov<-tukey_plotter(fall.aov, Chinook_WY.expanded[
                  Chinook_WY.expanded$RaceByLength=="Fall",], "Location", "Sac_Yrtype")
ggsave(plot=p_fall.aov, filename=file.path(save_dir, "Temp_region_drought_model.png"), device="png", height=6, width=7, units="in")
p_fall.aov


######################
# SacPAS regressions #
######################

# passage dates (first, percents, last) ~ Sac Index
  # % level as a factor/block?
  # each location/run separately...?

# TO START: plot single location, run, % level
plot(FirstPassageDate_wtrday~Sac_Index, data=Sherwood_fall)
plot(X5.PassageDate_wtrday~Sac_Index, data=Sherwood_fall)
plot(X10.PassageDate_wtrday~Sac_Index, data=Sherwood_fall)
plot(X25.PassageDate_wtrday~Sac_Index, data=Sherwood_fall)
plot(X50.PassageDate_wtrday~Sac_Index, data=Sherwood_fall)
plot(X75.PassageDate_wtrday~Sac_Index, data=Sherwood_fall)
plot(X90.PassageDate_wtrday~Sac_Index, data=Sherwood_fall)
plot(X95.PassageDate_wtrday~Sac_Index, data=Sherwood_fall)
plot(LastPassageDate_wtrday~Sac_Index, data=Sherwood_fall)
  # different realtionships for different metrics



# migration duration (percents) ~ Sac Index

# run size ~ Sac Index


##########################
# multi-level regression #
##########################

# travel data timing --> cumulative passage
# curve for each year
# regress annual curve stats (intercept, slope, LD50) 
  # against Sac Index
# each run/location separate??

# let's start with Sherwood fall-run
# create cumulative catch variable
# condense so we have one row per day first
Chinook_cum1 <- Chinook_WY[Chinook_WY$RaceByLength=="Fall" &
                             Chinook_WY$Location=="Sherwood Harbor",] %>%
  group_by(Date) %>%
  dplyr::summarize(
          Catch_sum = sum(Catch),
          Location = Location, 
          Run = RaceByLength,
          Date = Date, 
          wtr_day = wtr_day,
          WY = WY,
          Sac_Index = Sac_Index
          ) 
# remove duplicate rows
Chinook_cum1_unique <- Chinook_cum1[!duplicated(Chinook_cum1),]
#length(unique(Chinook_cum1$Date))
# cumulative catch by water day over each water year
Chinook_cum1_unique$csum <- ave(Chinook_cum1_unique$Catch_sum, 
                                Chinook_cum1_unique$WY, FUN=cumsum)
# plot to get a preliminary visual
  # csum by water day, color by water year
ggplot(Chinook_cum1_unique, aes(wtr_day,csum)) + 
  geom_line(aes(colour = as.factor(WY))) +
  labs(title = "Sherwood Harbor Trawl Fall-run Chinook",
       x = "water day", 
       y = "Cumulative Passage", color = "Water Year")

# let's do a model!
library(plyr)
library(dplyr)
library(lattice)
library(lubridate)
library(colorspace)
library(ggplot2)
library(arm)
library(MASS)
library(MCMCpack)
library(R2jags)
library(xtable)
library(lattice)

################ JAGS Model ######################
##### varying alphas and betas by water year #####
#########################

# switched from dbern in dissertation histo model to dbin
# there is still an error: 
  # Compilation error on line 7.
  # Index out of range taking subset of  alpha **********
#### ***do I need to change the logit link to something else?

sink("Trawl1 BHM.txt")
cat("
    model{

    # Level 1
    for(i in 1:n){
    passage[i] ~ dbin(p[i])
    logit(p[i]) <- alpha[group[i]] + beta[group[i]] * day[i]
    }
    
    # Level 2
    for (j in 1:J){ 
    alpha[j] ~ dnorm(mu.alpha, tau.alpha) # Intercepts 
    beta[j] ~ dnorm(mu.beta, tau.beta) # Slopes
    }
    
    # Priors

    mu.alpha ~ dnorm(0, 0.0001) # Hyperparameter for random intercepts
    tau.alpha <- pow(sigma.alpha, -2) 
    sigma.alpha ~ dunif(0, 10)
    sigma2.alpha <- pow(sigma.alpha, 2)

    mu.beta ~ dnorm(0, 0.0001) # Hyperparameter for random slopes
    tau.beta <- pow(sigma.beta, -2) 
    sigma.beta ~ dunif(0, 10)
    sigma2.beta <- pow(sigma.beta, 2)

    # L50
    for (i in 1:J){
    L50[i] <- -alpha[i]/beta[i]
    }


    }
    
    ",fill=TRUE)
sink()

# load data
n = dim(Chinook_cum1_unique)[1]
J = length(unique(Chinook_cum1_unique$WY))

data <- list(day = Chinook_cum1_unique$wtr_day, 
             passage = Chinook_cum1_unique$csum, 
             n = n,
             J = J, 
             group = as.numeric(as.factor(Chinook_cum1_unique$WY)))
        # used to be group = Chinook_cum1_unique$WY
        # this switched the error; idk if correct??


# Initial values
inits <- function (){
  list (mu.alpha = rnorm(1,0,1),
        mu.beta=rnorm(1,0,1),
        alpha=rep(0,J),
        beta=rep(0.01,J))
}


# Parameters monitored
params <- c("alpha","mu.alpha","beta","mu.beta","sigma.alpha", 
            "sigma.beta","L50")

# MCMC settings
ni <- 10000
nt <- 3
nb <- 1000
nc <- 3

out <- jags(data = data, inits = inits, parameters.to.save = params, 
            model.file = "Trawl1 BHM.txt", n.chains = nc, n.thin = nt, n.iter = ni, 
            n.burnin = nb)

print(out, digits = 3)
#str(out)

###########################
#     let's try a GLM     #
# similar to dissertation #
###########################

# create 0 to 1 variable
# need total by year
Chinook_cum1_unique <- Chinook_cum1_unique %>%
  group_by(WY) %>%
  dplyr::summarize(
          WY_sum = sum(Catch_sum),
          csum = csum,
          Catch_sum = Catch_sum,
          Location = Location, 
          Run = Run,
          Date = Date, 
          wtr_day = wtr_day,
          WY = WY,
          Sac_Index = Sac_Index
          ) 
# then divide csum by year total
Chinook_cum1_unique$perc_passage <- Chinook_cum1_unique$csum /
  Chinook_cum1_unique$WY_sum

marx = glm(perc_passage~factor(WY)*wtr_day, data=Chinook_cum1_unique,family=binomial)
# still issues with binomial - wants only 0 or 1
summary(marx)
marx.coef <- as.data.frame(marx$coef)

ggplot(Chinook_cum1_unique, aes(wtr_day,csum)) + 
  geom_line(aes(colour = as.factor(WY))) +
  labs(title = "Sherwood Harbor Trawl Fall-run Chinook",
       x = "water day", 
       y = "Cumulative Passage", color = "Water Year")

ggplot(Chinook_cum1_unique, aes(wtr_day,perc_passage)) + 
  geom_line(aes(colour = as.factor(WY))) +
  labs(title = "Sherwood Harbor Trawl Fall-run Chinook",
       x = "water day", 
       y = "Cumulative Passage", color = "Water Year")
# note that percent scales these all...

###################
# beta regression #
###################

if(!require(psych)){install.packages("psych")}
if(!require(betareg)){install.packages("betareg")}
if(!require(lmtest)){install.packages("lmtest")}
if(!require(rcompanion)){install.packages("rcompanion")}
if(!require(multcompView)){install.packages("multcompView")}
if(!require(emmeans)){install.packages("emmeans")}
if(!require(ggplot2)){install.packages("ggplot2")}

library(betareg)
# create a variable bounded by 1
Chinook_cum1_unique$perc_passage2 <- Chinook_cum1_unique$perc_passage - 0.0000000001
model = betareg(perc_passage2 ~ WY + wtr_day + WY:wtr_day,
                data = Chinook_cum1_unique)

library(emmeans)
joint_tests(model)
library(lmtest)
lrtest(model)
summary(model)
plot(fitted(model), residuals(model))
# very interesting patterns in residuals...

##################
# Poisson model? #
##################

# example code
model.count <- glmer(Count ~ x1 + x2 + x3 + (Time|SubID), 
                     family = poisson(link = "log"), data = df)

# my try
library(glmm)
model.count <- glmer(Catch_sum ~ wtr_day|WY, 
                     family = poisson(link = "log"), data = Chinook_cum1_unique)


###############################
##       Back to basics      ##
## create some summary plots ##
###############################

###########################################
#               Violin Plots              #
# violin plots grouped by water year type #
#   combine years and locations together  #
#             one plot per run            #
###########################################

# loop for violin plots - migration timing

# water year type should be ordered factor
Chinook_WY.expanded$Sac_Yrtype <- factor(Chinook_WY.expanded$Sac_Yrtype, 
                                      levels=c("C","D","BN","AN","W"), 
                                      ordered=TRUE)

runs <- unique(Chinook_WY.expanded$RaceByLength)
  # only want runs 1, 3, 4, 5
  # need separate for steelhead


  for (j in c(1,3,4,5)){ # j is run
    # need to wrap ggplot in print function for it to
    # plot within the loop
    print(ggplot(Chinook_WY.expanded[Chinook_WY.expanded$RaceByLength==
                           paste(runs[j]) ,], 
             aes(x=as.factor(Sac_Yrtype), y=wtr_day)) + 
    geom_violin() +
      labs(title = paste(noquote(runs[j]),"-run Chinook ","Migration Timing",sep=""), 
            x = "Water Year Type", 
           y = "Day of water year"))
    dev.copy(png,(paste("C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/",noquote(runs[j]),"-run Chinook ","Migration Timing",sep="")))
    dev.off()
 
  }


##########################################
#              Ridge Plots               #
# ridge plots grouped by water year type #
#     combine years and locations        #
#           ridge for each run           #
##########################################
library(ggridges)

# create data subset
  # only runs we want (not NA or adults, etc.)
  # years with water year type defined
Chinook_WY.expanded3 <- Chinook_WY.expanded[
  (Chinook_WY.expanded$RaceByLength %in% c("Winter","Fall",
                                          "Spring","LateFall")) 
  & !is.na(Chinook_WY.expanded$Sac_Yrtype),]

# single run
ggplot(Chinook_WY.expanded[Chinook_WY.expanded$RaceByLength==
                             "Winter",], aes(x = wtr_day, y = Sac_Yrtype, #color = RaceByLength, 
                                          fill = RaceByLength)) +
  geom_density_ridges(alpha = .8)

# multiple runs - using new dataset
ggplot(Chinook_WY.expanded3, aes(x = wtr_day, y = Sac_Yrtype, 
                                color = RaceByLength, 
                                fill = RaceByLength)) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Chinook Salmon Migration Timing (trawls 2012-2020)", 
            x = "Day of the water year", 
           y = "Water year type")


#################################
#          updated plots        #
# drought year groups - W, N, D #
#################################

# create new dataset to work with
  # only runs we want (not NA or adults, etc.)
Chinook_DY <- Chinook_WY.expanded[
  (Chinook_WY.expanded$RaceByLength %in% c("Winter","Fall",
                                          "Spring","LateFall")),]
# add in drought year classification
colnames(DroughtYr)[1] <- "WY"
Chinook_DY <- left_join(Chinook_DY, DroughtYr, by="WY")


##################################
#           ridge plots          #
# by drought year classification #
##################################

# all runs, all locations (like before)
# grouped by water year (like before)
ggplot(Chinook_DY, aes(x = wtr_day, y = Drought, 
                                color = RaceByLength, 
                                fill = RaceByLength)) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Chinook Salmon Migration Timing (trawls 2012-2021)", 
            x = "Day of the water year", 
           y = "Drought year type")
# grouped by run with drought year type in colors
ggplot(Chinook_DY, aes(x = wtr_day, y = RaceByLength, 
                                color = Drought, 
                                fill = Drought)) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Chinook Salmon Migration Timing (trawls 2012-2021)", 
            x = "Day of the water year", 
           y = "Run type")
    # I think this organization better

# all runs, split by trawl location
# Sherwood Harbor
ggplot(Chinook_DY[Chinook_DY$Location=="Sherwood Harbor",],
       aes(x = wtr_day, y = RaceByLength, 
                                color = Drought, 
                                fill = Drought)) +#scale_fill_manual(values=pal_drought) +
 # scale_color_manual(values=pal_drought) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Chinook Salmon Migration Timing - Sherwood Harbor Trawl (2012-2021)", 
            x = "Day of the water year", 
           y = "Run type")
# Chipp's Island
ggplot(Chinook_DY[Chinook_DY$Location=="Chipps Island",],
       aes(x = wtr_day, y = RaceByLength, 
                                color = Drought, 
                                fill = Drought)) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Chinook Salmon Migration Timing - Chipp's Island Trawl (2012-2021)", 
            x = "Day of the water year", 
           y = "Run type")
# Mossdale
ggplot(Chinook_DY[Chinook_DY$Location=="Mossdale",],
       aes(x = wtr_day, y = RaceByLength, 
                                color = Drought, 
                                fill = Drought)) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Chinook Salmon Migration Timing - Mossdale Trawl (2012-2021)", 
            x = "Day of the water year", 
           y = "Run type")

####################
#   violin plots   #
# by drought years #
####################

# winter-run, last 10 years
ggplot(Chinook_DY[Chinook_DY$RaceByLength==
                           "Winter",], 
             aes(x=as.factor(Drought), y=wtr_day)) + 
    geom_violin() +
      labs(title = "Winter-run Chinook Migration Timing", 
            x = "Drought Year Type", 
           y = "Day of water year")

# spring-run last 10 years
ggplot(Chinook_DY[Chinook_DY$RaceByLength==
                           "Spring",], 
             aes(x=as.factor(Drought), y=wtr_day)) + 
    geom_violin() +
      labs(title = "Spring-run Chinook Migration Timing", 
            x = "Drought Year Type", 
           y = "Day of water year")

# what if we loop?
runs <- unique((Chinook_DY$RaceByLength))
  for (j in 1:4){ # j is run
    # need to wrap ggplot in print function for it to
    # plot within the loop
    print(ggplot(Chinook_DY[Chinook_DY$RaceByLength==
                           paste(runs[j]) ,], 
             aes(x=as.factor(Drought), y=wtr_day)) + 
    geom_violin() +
      labs(title = paste(noquote(runs[j]),"-run Chinook ","Migration Timing",sep=""), 
            x = "Drought Year Type", 
           y = "Day of water year"))
    dev.copy(svg,(paste("C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/",noquote(runs[j]),"-run Chinook ","Migration Timing by drought year.svg",sep="")))
    dev.off()
 
  }



###################
#   fish length   #
# from trawl data #
###################

# consider lengths entering and exiting the Delta
# average length by run
# separate by drought year type

# all runs, split by trawl location
locations <- unique(Chinook_DY$Location)

for (i in 1:length(locations)){ # loop through trawl locations
  print(ggplot(Chinook_DY[Chinook_DY$Location==paste(noquote(locations[i])),],
       aes(x = FL, y = RaceByLength, 
                                color = Drought, 
                                fill = Drought)) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = paste(noquote(locations[i]),"Trawl Chinook Lengths"), 
            x = "Fork lengths", 
           y = "Run type"))
  dev.copy(svg,(paste("C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/",noquote(locations[i])," Fork Lengths",".svg",sep="")))
  dev.off()
}

######################################
# new things after fish MAST meeting #
#         *do colors/format*         #
######################################

############################
# run-specific ridge plots #
############################

########################
# do by year (not just drought/not)
# are there the same patterns as when years are combined
#######################

# all runs, all locations (like before)
# grouped by water year (like before)
ggplot(Chinook_DY, aes(x = wtr_day, y = factor(WY), 
                                color = RaceByLength, 
                                fill = RaceByLength)) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Chinook Salmon Migration Timing (trawls 2012-2021)", 
            x = "Day of the water year", 
           y = "Water year")
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Chinook migration by year.svg")
    dev.off()


# grouped by run with year in colors
ggplot(Chinook_DY, aes(x = wtr_day, y = RaceByLength, 
                                color = factor(WY), 
                                fill = factor(WY))) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Chinook Salmon Migration Timing (trawls 2012-2021)", 
            x = "Day of the water year", 
           y = "Run type")
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Chinook migration by year2.svg")
    dev.off()


# all runs, split by trawl location
# Sherwood Harbor
ggplot(Chinook_DY[Chinook_DY$Location=="Sherwood Harbor",],
       aes(x = wtr_day, y = RaceByLength, 
                                color = factor(WY), 
                                fill = factor(WY))) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Chinook Salmon Migration Timing - Sherwood Harbor Trawl (2012-2021)", 
            x = "Day of the water year", 
           y = "Run type")
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Sherwood by year.svg")
    dev.off()
    
# Chipp's Island
ggplot(Chinook_DY[Chinook_DY$Location=="Chipps Island",],
       aes(x = wtr_day, y = RaceByLength, 
                                color = factor(WY), 
                                fill = factor(WY))) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Chinook Salmon Migration Timing - Chipp's Island Trawl (2012-2021)", 
            x = "Day of the water year", 
           y = "Run type")
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Chipps by year.svg")
    dev.off()
    
# Mossdale
ggplot(Chinook_DY[Chinook_DY$Location=="Mossdale",],
       aes(x = wtr_day, y = RaceByLength, 
                                color = factor(WY), 
                                fill = factor(WY))) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Chinook Salmon Migration Timing - Mossdale Trawl (2012-2021)", 
            x = "Day of the water year", 
           y = "Run type")
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Mossdale by year.svg")
    dev.off()

############
# trying some other coloring
ggplot(Chinook_DY[Chinook_DY$Location=="Sherwood Harbor",],
       aes(x = wtr_day, y = RaceByLength, 
                                color = factor(WY), 
                                fill = Drought)) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Chinook Salmon Migration Timing - Sherwood Harbor Trawl (2012-2021)", 
            x = "Day of the water year", 
           y = "Run type")
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Sherwood by year colors2.svg")
    dev.off()
    
ggplot(Chinook_DY[Chinook_DY$Location=="Sherwood Harbor",],
       aes(x = wtr_day, y = RaceByLength, 
                                color = factor(WY), 
                                fill = Sac_Yrtype)) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Chinook Salmon Migration Timing - Sherwood Harbor Trawl (2012-2021)", 
            x = "Day of the water year", 
           y = "Run type")
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Sherwood by year colors3.svg")
    dev.off()
    
    
##########################
# runs stacked to compare Delta enatrance and exit
# have Sherwood and Chipp's stacked or side by side for each run

##################################
# Getting all the years together #
#   older and newer trawl files  #
#  starting over with data files #
##################################
# Sherwood & Chipp's ++ do color scheme!
###########################
# adding additional years #
###########################

# bring in the newer years first
# folder
setwd("C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/new trawls")
# create list of files in folder
file_list <- list.files()
# read in all files in the folder and combine
for (file in file_list){
  
  # if the merged dataset doesn't exist, create it
  if (file==file_list[1]){
    dataset <- read.csv(file, header=TRUE, stringsAsFactors = F)
    dataset$filename <- file # add filename as a column
  }
  
  # if the merged dataset does exist, append to it
  if (file!=file_list[1]){
    temp_dataset <-read.csv(file, header=TRUE, stringsAsFactors = F)
    temp_dataset$filename <- file
    dataset<-rbind(dataset, temp_dataset)
    rm(temp_dataset)
  }
}

df1 <- dataset
remove(file)
remove(file_list)
remove(dataset)

# now bring in older years
# folder
setwd("C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/older trawls")
# create list of files in folder
file_list <- list.files()
# read in all files in the folder and combine
for (file in file_list){
  
  # if the merged dataset doesn't exist, create it
  if (file==file_list[1]){
    dataset <- read.csv(file, header=TRUE, stringsAsFactors = F)
    dataset$filename <- file # add filename as a column
  }
  
  # if the merged dataset does exist, append to it
  if (file!=file_list[1]){
    temp_dataset <-read.csv(file, header=TRUE, stringsAsFactors = F)
    temp_dataset$filename <- file
    dataset<-rbind(dataset, temp_dataset)
    rm(temp_dataset)
  }
}

df2 <- dataset
remove(file)
remove(file_list)
remove(dataset)

# are these good to merge together?
dim(df1)
dim(df2)
str(df1)
str(df2)
colnames(df1)
colnames(df2)
# merge them!
trawl_all <- rbind(df1,df2)
dim(trawl_all)
# 160862+675910 = 836772
# remove(df1, df2)

#################################################
# same data cleaning, fixing variables as above #
#################################################
# change date and time to date and time formats ********* change df name
  trawl_all$Date <- mdy(trawl_all$Date)
  trawl_all$mday <- mday(trawl_all$Date)
# add Water Year as column
  # binary for whether water year and calendar year are the same
  trawl_all$same_year <- as.numeric(between(month(trawl_all$Date),10,12))
  # water year (WY) column
  trawl_all$WY <- year(trawl_all$Date) + trawl_all$same_year

# let's get water day (day of year but for water year)
# use difftime to get wtr_day to be the number of days from 9-30 
# in the previous water year (WY)
# for Chinook dataset first (could have done for all trawl data initially...)
trawl_all <- trawl_all %>%
  group_by(WY) %>% 
  mutate(wtr_day = (as.integer(difftime(
    Date,ymd(paste0(WY - 1 ,'-09-30')), units = "days"))))

# combine Water Year and water index data
trawl_all <- left_join(trawl_all, WaterYr)
# change column name for sac year type
colnames(trawl_all)[30] <- "Sac_Yrtype"
colnames(trawl_all)[32] <- "SJ_Yrtype"
# add in drought year period classification
trawl_all <- left_join(trawl_all, DroughtYr, by="WY")

# remove incomplete years
#Chinook_WY <- Chinook_WY[(Chinook_WY$WY > 2011),]
#Chinook_WY <- Chinook_WY[(Chinook_WY$WY < 2022),]

# water year type should be ordered factor
trawl_all$Sac_Yrtype <- factor(trawl_all$Sac_Yrtype, 
                                      levels=c("C","D","BN","AN","W"), 
                                      ordered=TRUE)
trawl_all$SJ_Yrtype <- factor(trawl_all$SJ_Yrtype, 
                                      levels=c("C","D","BN","AN","W"), 
                                      ordered=TRUE)
##################
# Chinook subset #
##################

# subset for just Chinook salmon; all trawl years, all trawls
Chinook_all <- trawl_all[trawl_all$Species=="CHN",]
# create species/run variable for when combining with steelhead
  # this is inefficient!! *******************************************************
#for (i in 1:length(Chinook_all$RaceByLength)){
#  Chinook_all$Species_Run[i] <- paste(Chinook_all$RaceByLength[i],
#                                               "-run Chinook",sep="")}
# trying something different to define runs:
Chinook_all$Species_Run <- NA
Chinook_all[Chinook_all$RaceByLength=="Fall","Species_Run"] <- "Fall-run Chinook"
Chinook_all[Chinook_all$RaceByLength=="LateFall","Species_Run"] <- "Late Fall-run Chinook"
Chinook_all[Chinook_all$RaceByLength=="Spring","Species_Run"] <- "Spring-run Chinook"
Chinook_all[Chinook_all$RaceByLength=="Winter","Species_Run"] <- "Winter-run Chinook"

# expand rows to account for Catch
Chinook_all.expanded <- Chinook_all[rep(row.names(Chinook_all), Chinook_all$Catch), ]
# only runs we want (not NA or adults, etc.)
Chinook_all.expanded <- Chinook_all.expanded[
  (Chinook_all.expanded$RaceByLength %in% c("Winter","Fall",
                                          "Spring","LateFall")),]


########################
# Steelhead/RBT subset #
########################

# subset for just rainbow trout/steelhead; all trawl years, all trawls
RBT_all <- trawl_all[trawl_all$Species=="RBT",]
# expand rows to account for Catch
RBT_all.expanded <- RBT_all[rep(row.names(RBT_all), RBT_all$Catch), ]
# create species/run variable for when combining with Chinook
RBT_all.expanded$Species_Run <- "Rainbow trout/steelhead"
# remove adults
RBT_all.expanded <- RBT_all.expanded[!(RBT_all.expanded$RaceByLength=="Adult"),]

# are there other indicators of rows we don't want?? *****************

# note there are many ad clipped RBT
table(RBT_all.expanded$Mark)
table(Chinook_all.expanded$Mark)

# plot RBT alone first, by mark
ggplot(RBT_all.expanded[RBT_all.expanded$Location=="Sherwood Harbor",],
       aes(x = wtr_day, y = Mark, 
                                color = Drought, 
                                fill = Drought)) +scale_fill_manual(values=pal_drought) +
  scale_color_manual(values=pal_drought) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "RBT Migration Timing - Sherwood Harbor Trawl", 
            x = "Day of the water year", 
           y = "Mark type") + theme_bw()
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Sherwood RBT all years by mark.svg")
    dev.off()
ggplot(RBT_all.expanded[RBT_all.expanded$Location=="Chipps Island",],
       aes(x = wtr_day, y = Mark, 
                                color = Drought, 
                                fill = Drought)) +scale_fill_manual(values=pal_drought) +
  scale_color_manual(values=pal_drought) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "RBT Migration Timing - Chipp's Island Trawl", 
            x = "Day of the water year", 
           y = "Mark type") + theme_bw()
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Chipps RBT all years by mark.svg")
    dev.off()

###########################
# combine Chinook and RBT #
###########################
Chinook_RBT_all.expanded <- rbind(Chinook_all.expanded,RBT_all.expanded)

################################
# Color Scheme to match others #
################################

# colors from Rosy/drought group
pal_drought <- c( "D" = "#FDE333", "N" = "#53CC67","W" = "#00588B")
pal_yrtype <- c( "Critical" = "#FDE333", "Dry" = "#53CC67", "Below Normal" = "#009B95","Above Normal" = "#00588B", "Wet" = "#4B0055")
pal_yrtype2 <- c( "C" = "#FDE333", "D" = "#53CC67", "BN" = "#009B95","AN" = "#00588B", "W" = "#4B0055")

# use theme_bw()

###################################
# new ridge plots with more years #
###################################

############################
# run-specific ridge plots #
############################

########################
# do by year (not just drought/not)
# are there the same patterns as when years are combined
#######################

# all runs, all locations (like before)
# grouped by water year (like before)
ggplot(Chinook_all.expanded, aes(x = wtr_day, y = factor(WY), 
                                color = RaceByLength, 
                                fill = RaceByLength)) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Chinook Salmon Migration Timing (trawls 1976-2021)", 
            x = "Day of the water year", 
           y = "Water year") + theme_bw()
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Chinook migration by year all.svg")
    dev.off()


# grouped by run with year in colors
ggplot(Chinook_all.expanded, aes(x = wtr_day, y = RaceByLength, 
                                color = factor(WY), 
                                fill = factor(WY))) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Chinook Salmon Migration Timing (trawls 1976-2021)", 
            x = "Day of the water year", 
           y = "Run type") + theme_bw()
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Chinook migration by year2 all.svg")
    dev.off()


# all runs, split by trawl location
# Sherwood Harbor
ggplot(Chinook_all.expanded[Chinook_all.expanded$Location=="Sherwood Harbor",],
       aes(x = wtr_day, y = RaceByLength, 
                                color = factor(WY), 
                                fill = factor(WY))) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Chinook Salmon Migration Timing - Sherwood Harbor Trawl (1988-2021)", 
            x = "Day of the water year", 
           y = "Run type") + theme_bw()
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Sherwood by year all.svg")
    dev.off()
    
# Chipp's Island
ggplot(Chinook_all.expanded[Chinook_all.expanded$Location=="Chipps Island",],
       aes(x = wtr_day, y = RaceByLength, 
                                color = factor(WY), 
                                fill = factor(WY))) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Chinook Salmon Migration Timing - Chipp's Island Trawl (1976-2021)", 
            x = "Day of the water year", 
           y = "Run type") + theme_bw()
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Chipps by year all.svg")
    dev.off()
    
# Mossdale
ggplot(Chinook_all.expanded[Chinook_all.expanded$Location=="Mossdale",],
       aes(x = wtr_day, y = RaceByLength, 
                                color = factor(WY), 
                                fill = factor(WY))) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Chinook Salmon Migration Timing - Mossdale Trawl (1994-2021)", 
            x = "Day of the water year", 
           y = "Run type") + theme_bw()
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Mossdale by year all.svg")
    dev.off()

############
# trying some other coloring
ggplot(Chinook_all.expanded[Chinook_all.expanded$Location=="Sherwood Harbor",],
       aes(x = wtr_day, y = RaceByLength, 
                                color = factor(WY), 
                                fill = Drought)) + scale_fill_manual(values=pal_drought) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Chinook Salmon Migration Timing - Sherwood Harbor Trawl (1988-2021)", 
            x = "Day of the water year", 
           y = "Run type") + theme_bw()
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Sherwood by year colors2 all.svg")
    dev.off()
    
ggplot(Chinook_all.expanded[Chinook_all.expanded$Location=="Sherwood Harbor",],
       aes(x = wtr_day, y = RaceByLength, 
                                color = factor(WY), 
                                fill = Sac_Yrtype)) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Chinook Salmon Migration Timing - Sherwood Harbor Trawl (1988-2021)", 
            x = "Day of the water year", 
           y = "Run type") + theme_bw()
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Sherwood by year colors3 all.svg")
    dev.off()
    
##############################################  
# Back to summarizing rather than by year analysis
# all runs, split by trawl location
    # add in RBT
    # clip years
# Sherwood Harbor
ggplot(Chinook_RBT_all.expanded[(Chinook_RBT_all.expanded$Location=="Sherwood Harbor" &
                                   Chinook_RBT_all.expanded$WY > 1987),],
       aes(x = wtr_day, y = Species_Run, 
                                color = Drought, 
                                fill = Drought)) +scale_fill_manual(values=pal_drought) +
  scale_color_manual(values=pal_drought) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Sherwood Harbor Trawl Migration Timing (1988-2021)", 
            x = "Day of the water year", 
           y = "Species/Run type") + theme_bw()
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Sherwood 1988.svg")
    dev.off()
# Chipp's Island
ggplot(Chinook_RBT_all.expanded[(Chinook_RBT_all.expanded$Location=="Chipps Island" &
                                   Chinook_RBT_all.expanded$WY > 1987),],
       aes(x = wtr_day, y = Species_Run, 
                                color = Drought, 
                                fill = Drought)) +scale_fill_manual(values=pal_drought) +
  scale_color_manual(values=pal_drought) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Chipp's Island Trawl Migration Timing (1988-2021)", 
            x = "Day of the water year", 
           y = "Species/Run type") + theme_bw()
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Chipps 1988.svg")
    dev.off()
# Mossdale
#ggplot(Chinook_all.expanded[Chinook_all.expanded$Location=="Mossdale",],
#       aes(x = wtr_day, y = RaceByLength, 
#                                color = Drought, 
#                                fill = Drought)) +scale_fill_manual(values=pal_drought) +
#  scale_color_manual(values=pal_drought) +
#  geom_density_ridges(alpha = .5, scale=0.95) +
#  labs(title = "Chinook Salmon Migration Timing - Mossdale Trawl (1994-2021)", 
#            x = "Day of the water year", 
#           y = "Run type") + theme_bw()
#    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Mossdale all years.svg")
#    dev.off()

    
######################
# Sherwood - only MWR #
# Sherwood Harbor
ggplot(Chinook_RBT_all.expanded[(Chinook_RBT_all.expanded$Location=="Sherwood Harbor" &
                                   Chinook_RBT_all.expanded$WY > 1987&
                                  Chinook_RBT_all.expanded$Method=="MWTR"),],
       aes(x = wtr_day, y = Species_Run, 
                                color = Drought, 
                                fill = Drought)) +scale_fill_manual(values=pal_drought) +
  scale_color_manual(values=pal_drought) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Sherwood Harbor Trawl Migration Timing (1988-2021)", 
            x = "Day of the water year", 
           y = "Species/Run type") + theme_bw()
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Sherwood 1988 MWTR.svg")
    dev.off()
# check difference between trawl types
ggplot(Chinook_RBT_all.expanded[(Chinook_RBT_all.expanded$Location=="Sherwood Harbor" &
                                   Chinook_RBT_all.expanded$WY > 1987),],
       aes(x = wtr_day, y = Species_Run, 
                                color = Method, 
                                fill = Method)) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Sherwood Harbor Trawl Migration Timing (1988-2021)", 
            x = "Day of the water year", 
           y = "Species/Run type") + theme_bw()
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Sherwood 1988 KDTR v MWTR.svg")
    dev.off()
    
####################################################
# check what they look like by water year type too #
####################################################

# Sherwood Harbor
ggplot(Chinook_RBT_all.expanded[Chinook_RBT_all.expanded$Location=="Sherwood Harbor",],
       aes(x = wtr_day, y = Species_Run, 
                                color = Yr_type, 
                                fill = Yr_type)) +
  scale_fill_manual(values=pal_yrtype, name="Year Type") +
  scale_color_manual(values=pal_yrtype, name="Year Type") +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Sherwood Harbor Trawl Migration Timing (1988-2021)", 
            x = "Day of the water year", 
           y = "Species/Run type") + theme_bw()
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Sherwood all years w RBT yrtype.svg")
    dev.off()
# Chipp's Island
ggplot(Chinook_RBT_all.expanded[Chinook_RBT_all.expanded$Location=="Chipps Island",],
       aes(x = wtr_day, y = Species_Run, 
                                color = Yr_type, 
                                fill = Yr_type)) +
  scale_fill_manual(values=pal_yrtype, name="Year Type") +
  scale_color_manual(values=pal_yrtype, name="Year Type") +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Chipp's Island Trawl Migration Timing (1976-2021)", 
            x = "Day of the water year", 
           y = "Species/Run type") + theme_bw()
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Chipps all years w RBT yrtype.svg")
    dev.off()

# sample size tables - from 1988 - 2021 data
Chipps <- Chinook_RBT_all.expanded[(Chinook_RBT_all.expanded$Location=="Chipps Island"&
                                   Chinook_RBT_all.expanded$WY > 1987),]
table(Chipps$Species_Run)
Sherwood <- Chinook_RBT_all.expanded[(Chinook_RBT_all.expanded$Location=="Sherwood Harbor"&
                                   Chinook_RBT_all.expanded$WY > 1987),]
table(Sherwood$Species_Run)

#############################
#        FINAL PLOTS        #
#        WR, SR, FR         #
# no late fall or steelhead #
#     timing and lengths    #
#############################

Chinook_all.expanded2 <- Chinook_all.expanded[
  ((Chinook_all.expanded$RaceByLength %in% c("Winter","Fall",
                                          "Spring"))&
                                   Chinook_all.expanded$WY > 1987),]

# Migration timing
# Sherwood Harbor
ggplot(Chinook_all.expanded2[Chinook_all.expanded2$Location=="Sherwood Harbor",],
       aes(x = wtr_day, y = Species_Run, 
                                color = Drought, 
                                fill = Drought)) +scale_fill_manual(values=pal_drought) +
  scale_color_manual(values=pal_drought) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Sherwood Harbor Trawl Migration Timing (1988-2021)", 
            x = "Day of the water year", 
           y = "Run type") + theme_bw()
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Sherwood final timing.svg")
    dev.off()
# Chipps Island
ggplot(Chinook_all.expanded2[Chinook_all.expanded2$Location=="Chipps Island",],
       aes(x = wtr_day, y = Species_Run, 
                                color = Drought, 
                                fill = Drought)) +scale_fill_manual(values=pal_drought) +
  scale_color_manual(values=pal_drought) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Chipps Island Trawl Migration Timing (1988-2021)", 
            x = "Day of the water year", 
           y = "Run type") + theme_bw()
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Chipps final timing.svg")
    dev.off()

# Lengths
Chinook_all.expanded3 <- Chinook_all.expanded2[Chinook_all.expanded2$FL>0,]
# Sherwood Harbor
ggplot(Chinook_all.expanded3[Chinook_all.expanded3$Location=="Sherwood Harbor",],
       aes(x = FL, y = Species_Run, 
                                color = Drought, 
                                fill = Drought)) +scale_fill_manual(values=pal_drought) +
  scale_color_manual(values=pal_drought) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Sherwood Harbor Trawl Fish Lengths (1988-2021)", 
            x = "Fork length", 
           y = "Run type") + theme_bw()
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Sherwood final lengths.svg")
    dev.off()
# Chipps Island
ggplot(Chinook_all.expanded3[Chinook_all.expanded3$Location=="Chipps Island",],
       aes(x = FL, y = Species_Run, 
                                color = Drought, 
                                fill = Drought)) +scale_fill_manual(values=pal_drought) +
  scale_color_manual(values=pal_drought) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Chipps Island Trawl Fish Lengths (1988-2021)", 
            x = "Fork length", 
           y = "Run type") + theme_bw()
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Chipps final lengths.svg")
    dev.off()

# winter-run lengths only - both trawls
ggplot(Chinook_all.expanded3[Chinook_all.expanded3$RaceByLength=="Winter"&
                               (Chinook_all.expanded3$Location=="Chipps Island" |
                               Chinook_all.expanded3$Location=="Sherwood Harbor"),],
       aes(x = FL, y = Location, 
                                color = Drought, 
                                fill = Drought)) +scale_fill_manual(values=pal_drought) +
  scale_color_manual(values=pal_drought) +
  geom_density_ridges(alpha = .5, scale=0.7) +
  labs(title = "Chipps Island Trawl Winter-run Chinook Lengths (1988-2021)", 
            x = "Fork length", 
           y = "Trawl Location") + theme_bw()
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Winter-run lengths.svg")
    dev.off()
    
############
# sample sizes
# sample sizes *for migration timing*
    # lengths has less due to zeros
Chipps <- Chinook_all.expanded2[Chinook_all.expanded2$Location=="Chipps Island",]
table(Chipps$Species_Run) # not matching up

Sherwood <- Chinook_all.expanded2[Chinook_all.expanded2$Location=="Sherwood Harbor",]
table(Sherwood$Species_Run)

# for lengths
Chipps <- Chinook_all.expanded3[Chinook_all.expanded3$Location=="Chipps Island",]
table(Chipps$Species_Run)
Sherwood <- Chinook_all.expanded3[Chinook_all.expanded3$Location=="Sherwood Harbor",]
table(Sherwood$Species_Run)

#####################
# Boxplots for Evan #
#   escapement/CRR  #
#####################

# winter-run
WR_CRR <- 
read_excel("C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/Grandtab WR & SR CRR.xlsx",
           sheet = "WR Drought years")
# boxplot
ggplot(WR_CRR, aes(x=Drought, y=CRR, fill=Drought)) + 
    geom_boxplot() +theme_bw() + scale_fill_manual(values=pal_drought)+
    labs(title = "Age Structure Winter-run CRR 1973-2020", 
            x = "Juvenile migration year type", 
           y = "Cohort Replacement Rate (CRR)")+
    stat_summary(fun=mean, geom="point", shape=4, size=2, color="black")
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/Winter-run CRR.svg")
    dev.off()

# spring-run
SR_CRR <- 
read_excel("C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/Grandtab WR & SR CRR.xlsx",
           sheet = "Spring Run (All)")
# boxplot
ggplot(SR_CRR, aes(x=Drought, y=CRR, fill=Drought)) + 
    geom_boxplot() +theme_bw() + scale_fill_manual(values=pal_drought)+
    labs(title = "Age Structure Spring-run CRR 1973-2020", 
            x = "Juvenile migration year type", 
           y = "Cohort Replacement Rate (CRR)")+
    stat_summary(fun=mean, geom="point", shape=4, size=2, color="black")
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/Spring-run CRR.svg")
    dev.off()
    
# Fall-run
FR_CRR <- 
read_excel("C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/Grandtab WR Fr SR CRR.xlsx",
           sheet = "Fall Run")
colnames(FR_CRR)[2] <- "Drought"
# boxplot
ggplot(FR_CRR, aes(x=Drought, y=CRR, fill=Drought)) + 
    geom_boxplot() +theme_bw() + scale_fill_manual(values=pal_drought)+
    labs(title = "Age Structure Fall-run CRR 1973-2020", 
            x = "Juvenile migration year type", 
           y = "Cohort Replacement Rate (CRR)")+
    stat_summary(fun=mean, geom="point", shape=4, size=2, color="black")
    dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/Fall-run CRR.svg")
    dev.off()
  

#########################
## migration over time ##
#########################

# boxplot
Chinook_all_juv <- Chinook_all.expanded[
  !Chinook_all.expanded$RaceByLength=="Adult",]
    
ggplot(Chinook_all_juv[Chinook_all_juv$Location=="Chipps Island",],
       aes(x=WY, y=wtr_day, group=WY, fill=Drought)) + 
    geom_boxplot() +theme_bw()+ scale_fill_manual(values=pal_drought)+
    labs(title = "Chipps Island Trawl Migration Timing (1976-2021)", 
            x = "water year", 
           y = "water day")#+
    #stat_summary(fun=mean, geom="point", shape=4, size=2, color="black")
    #dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/Fall-run CRR.svg")
    #dev.off()

# ridge plot
ggplot(Chinook_all_juv[Chinook_all_juv$Location=="Chipps Island",],
       aes(x = wtr_day, y = as.factor(WY), 
                                color = Drought, 
                                fill = Drought)) +scale_fill_manual(values=pal_drought) +
  scale_color_manual(values=pal_drought) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Chipps Island Trawl Migration Timing (1976-2021)", 
            x = "Day of the water year", 
           y = "Water Year") + theme_bw()
    #dev.copy(svg,"C:/Users/Elizabeth.keller/Desktop/DCP/Drought data/FWS DJFMP/plots/Chipps final timing.svg")
    #dev.off()

# boxplot - fall only
ggplot(Chinook_all_juv[Chinook_all_juv$Location=="Chipps Island"&
                         Chinook_all_juv$RaceByLength=="Fall",],
       aes(x=WY, y=wtr_day, group=WY, fill=Drought)) + 
    geom_boxplot() +theme_bw()+ scale_fill_manual(values=pal_drought)+
    labs(title = "Chipps Island Trawl Fall-run Migration Timing (1976-2021)", 
            x = "water year", 
           y = "water day")

# ridge plot - fall only
ggplot(Chinook_all_juv[Chinook_all_juv$Location=="Chipps Island" &
                         Chinook_all_juv$RaceByLength=="Fall",],
       aes(x = wtr_day, y = as.factor(WY), 
                                color = Drought, 
                                fill = Drought)) +scale_fill_manual(values=pal_drought) +
  scale_color_manual(values=pal_drought) +
  geom_density_ridges(alpha = .5, scale=0.95) +
  labs(title = "Chipps Island Trawl Fall-run Migration Timing (1976-2021)", 
            x = "Day of the water year", 
           y = "Water Year") + theme_bw()

# boxplot - winter only
ggplot(Chinook_all_juv[Chinook_all_juv$Location=="Chipps Island"&
                         Chinook_all_juv$RaceByLength=="Winter",],
       aes(x=WY, y=wtr_day, group=WY, fill=Drought)) + 
    geom_boxplot() +theme_bw()+ scale_fill_manual(values=pal_drought)+
    labs(title = "Chipps Island Trawl Winter-run Migration Timing (1976-2021)", 
            x = "water year", 
           y = "water day")
